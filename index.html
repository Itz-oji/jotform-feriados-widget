<script>
  const COUNTRY = "CL";

  const $count = document.getElementById("count");
  const $status = document.getElementById("status");
  const $listWrap = document.getElementById("listWrap");
  const $list = document.getElementById("list");

  // Cambia este nombre si tu URL param se llama distinto:
  const START_PARAM = "escribaUna34"; // <-- tu parámetro

  function parseAnyDate(str) {
    if (!str) return null;

    // YYYY-MM-DD
    if (/^\d{4}-\d{2}-\d{2}$/.test(str)) {
      const [y, m, d] = str.split("-").map(Number);
      return new Date(y, m - 1, d);
    }

    // DD/MM/YYYY
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(str)) {
      const [d, m, y] = str.split("/").map(Number);
      return new Date(y, m - 1, d);
    }

    return null;
  }

  async function fetchHolidays(year) {
    const url = `https://date.nager.at/api/v3/PublicHolidays/${year}/${COUNTRY}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("No se pudo consultar feriados");
    return await res.json();
  }

  function sameMonth(dateObj, year, monthIndex0) {
    return (
      dateObj &&
      dateObj.getFullYear() === year &&
      dateObj.getMonth() === monthIndex0
    );
  }

  async function computeFromStartDate(startStr) {
    const startDate = parseAnyDate(startStr);

    if (!startDate) {
      $count.textContent = "—";
      $status.textContent = "Falta o es inválida la fecha de inicio (URL param).";
      $listWrap.style.display = "none";
      return;
    }

    const year = startDate.getFullYear();
    const month = startDate.getMonth(); // 0-11

    $status.textContent = `Consultando feriados de ${String(month + 1).padStart(2,"0")}/${year}…`;

    try {
      const holidays = await fetchHolidays(year);

      // Filtra feriados del mismo mes
      const hits = holidays.filter(h => {
        const d = parseAnyDate(h.date); // h.date viene YYYY-MM-DD
        return sameMonth(d, year, month);
      });

      $count.textContent = hits.length.toString();

      // Render lista
      $list.innerHTML = "";
      if (hits.length) {
        hits.sort((a,b)=> a.date.localeCompare(b.date));
        for (const h of hits) {
          const li = document.createElement("li");
          li.textContent = `${h.date} — ${h.localName || h.name}`;
          $list.appendChild(li);
        }
        $listWrap.style.display = "block";
        $status.textContent = `Feriados del mes ${String(month + 1).padStart(2,"0")}/${year} (según inicio: ${startStr})`;
      } else {
        $listWrap.style.display = "none";
        $status.textContent = `No hay feriados en ${String(month + 1).padStart(2,"0")}/${year}`;
      }

    } catch (e) {
      $count.textContent = "—";
      $status.textContent = "Error consultando feriados (API o conexión).";
      $listWrap.style.display = "none";
    }
  }

  function readStartFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get(START_PARAM) || params.get("start") || "";
  }

  // Ejecuta al cargar
  const startStr = readStartFromUrl();
  if (!startStr) {
    $status.textContent = `Esperando fecha… (usa ?${START_PARAM}=YYYY-MM-DD)`;
  } else {
    computeFromStartDate(startStr);
  }
</script>

